services:
  traefik:
    image: traefik:v2.11
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false

      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443

      - --certificatesresolvers.le.acme.httpchallenge=true
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
      - --certificatesresolvers.le.acme.email=desh1993@protonmail.com
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json

      - --log.level=INFO
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt

  app:
    build:
      context: .
      dockerfile: docker/production/Dockerfile
      args:
        VITE_PUSHER_APP_KEY: ${VITE_PUSHER_APP_KEY}
        VITE_PUSHER_APP_CLUSTER: ${VITE_PUSHER_APP_CLUSTER}
    image: fitness-mvp:latest
    env_file: .env.production
    environment:
      AUTORUN_ENABLED: 'true'
      AUTORUN_LARAVEL_STORAGE_LINK: 'true'
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
      - app_storage:/var/www/html/storage
      - app_logs:/var/www/html/storage/logs
    restart: unless-stopped
    labels:
      - 'traefik.enable=true'

      # HTTP router (redirect to HTTPS)
      - 'traefik.http.routers.fitness-http.rule=Host(`fitness.deshtest.com`)'
      - 'traefik.http.routers.fitness-http.entrypoints=web'
      - 'traefik.http.routers.fitness-http.middlewares=redirect-to-https'
      - 'traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https'

      # HTTPS router
      - 'traefik.http.routers.fitness.rule=Host(`fitness.deshtest.com`)'
      - 'traefik.http.routers.fitness.entrypoints=websecure'
      - 'traefik.http.routers.fitness.tls=true'
      - 'traefik.http.routers.fitness.tls.certresolver=le'

      # Your app listens on 8080 in the container
      - 'traefik.http.services.fitness.loadbalancer.server.port=8080'

  scheduler:
    image: fitness-mvp:latest
    command: ['php', '/var/www/html/artisan', 'schedule:work']
    env_file: .env.production
    environment:
      AUTORUN_ENABLED: 'false'
    stop_signal: SIGTERM
    healthcheck:
      test: ['CMD', 'healthcheck-schedule']
      start_period: 10s
    depends_on:
      - mysql
    volumes:
      - app_logs:/var/www/html/storage/logs
    restart: unless-stopped

  queue:
    image: fitness-mvp:latest
    command:
      [
        '/bin/sh',
        '-c',
        'sleep 20 && php /var/www/html/artisan queue:work --tries=3',
      ]
    env_file: .env.production
    environment:
      AUTORUN_ENABLED: 'false'
    stop_signal: SIGTERM
    healthcheck:
      test: ['CMD', 'healthcheck-queue']
      start_period: 10s
    depends_on:
      - mysql
    volumes:
      - app_logs:/var/www/html/storage/logs
    restart: unless-stopped

  mysql:
    image: mysql:8.4
    environment:
      - MYSQL_DATABASE=${DB_DATABASE:-fitness_mvp}
      - MYSQL_USER=${DB_USERNAME:-fitness_user}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-${DB_PASSWORD}}
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

volumes:
  mysql_data:
  app_storage:
  app_logs:
